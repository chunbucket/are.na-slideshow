<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ency ‚Äî Are.na Slideshow</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #0a0a0a;
      --fg: #e8e8e8;
      --dim: #666;
      --accent: #3d5afe;
    }

    body {
      font-family: 'IBM Plex Mono', monospace;
      background: var(--bg);
      color: var(--fg);
      min-height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 2rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #222;
      flex-shrink: 0;
    }

    .channel-title {
      font-size: 0.85rem;
      font-weight: 500;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .channel-title a {
      color: var(--fg);
      text-decoration: none;
    }

    .channel-title a:hover {
      color: var(--accent);
    }

    .controls {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .counter {
      font-size: 0.75rem;
      color: var(--dim);
      font-variant-numeric: tabular-nums;
    }

    button {
      background: transparent;
      border: 1px solid #333;
      color: var(--fg);
      padding: 0.5rem 1rem;
      font-family: inherit;
      font-size: 0.7rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    button:hover {
      background: var(--fg);
      color: var(--bg);
    }

    button.active {
      background: var(--accent);
      border-color: var(--accent);
    }

    .stage {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .slide {
      position: absolute;
      inset: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.98);
      transition: opacity 0.6s ease, transform 0.6s ease;
      pointer-events: none;
    }

    .slide.active {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }

    .slide img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .slide-text {
      max-width: 800px;
      font-size: 1.5rem;
      line-height: 1.6;
      text-align: center;
      padding: 2rem;
    }

    .slide-link {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      text-align: center;
      max-width: 600px;
    }

    .slide-link img {
      max-width: 100%;
      max-height: 60vh;
      border-radius: 4px;
    }

    .slide-link a {
      color: var(--accent);
      font-size: 0.85rem;
      word-break: break-all;
    }

    .slide-link .link-title {
      font-size: 1.1rem;
      color: var(--fg);
      margin-bottom: 0.5rem;
    }

    .slide-embed iframe {
      max-width: 100%;
      max-height: 80vh;
      border: none;
    }

    .slide-attachment {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .slide-attachment .file-icon {
      font-size: 4rem;
      opacity: 0.3;
    }

    .slide-attachment a {
      color: var(--accent);
      font-size: 0.85rem;
    }

    footer {
      padding-top: 1.5rem;
      border-top: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      gap: 1rem;
    }

    .footer-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.5rem;
    }

    .timer-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    #fullscreen-btn {
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      flex-shrink: 0;
    }

    #shuffle-btn {
      border: none;
      padding: 0.5rem;
      font-size: 2rem;
      flex-shrink: 0;
    }

    #shuffle-btn:hover {
      background: transparent;
      color: var(--accent);
    }

    #shuffle-btn.active {
      color: var(--accent);
    }

    .speed-control {
      position: relative;
      width: 200px;
      padding-left: 6px;
      padding-right: 6px;
      margin-bottom: 0.5rem;
    }

    #speed-slider {
      width: 100%;
      height: 2px;
      -webkit-appearance: none;
      appearance: none;
      background: #222;
      outline: none;
      cursor: pointer;
      position: relative;
    }

    .slider-progress {
      position: absolute;
      left: 6px;
      top: 0;
      height: 2px;
      background: var(--accent);
      width: 0%;
      pointer-events: none;
      transition: none;
    }

    .slider-progress.paused {
      transition: none;
    }

    .speed-label-wrapper {
      position: absolute;
      top: 50%;
      left: -20px;
      pointer-events: none;
      transform: translateY(-50%);
    }

    .speed-label {
      transition: opacity 0.3s ease;
      white-space: nowrap;
      opacity: 0;
      text-align: right;
    }

    .speed-label.visible {
      opacity: 1;
    }

    #speed-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      background: var(--accent);
      cursor: pointer;
      border-radius: 50%;
    }

    #speed-slider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: var(--accent);
      cursor: pointer;
      border-radius: 50%;
      border: none;
    }

    .speed-label {
      font-size: 0.65rem;
      color: var(--dim);
      min-width: 30px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .block-title {
      font-size: 0.75rem;
      color: var(--dim);
      max-width: 60%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #333;
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      text-align: center;
      color: #ff5252;
    }

    .nav-hint {
      position: fixed;
      bottom: 2.4rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.65rem;
      color: var(--dim);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="channel-title">
        <span id="channel-name">Are.na Slideshow</span>
      </div>
      <div class="controls">
        <span class="counter" id="counter">‚Äî/‚Äî</span>
        <button id="prev-btn">‚Üê Prev</button>
        <button id="play-btn">Pause</button>
        <button id="next-btn">Next ‚Üí</button>
      </div>
    </header>

    <div class="stage" id="stage">
      <div class="slide-text">
        <p style="font-size: 1rem; margin-bottom: 1rem;">Paste or drop an Are.na link</p>
        <input type="text" id="channel-input" placeholder="https://www.are.na/username/channel-slug"
          style="width: 100%; padding: 0.75rem; background: #1a1a1a; border: 1px solid #333; color: var(--fg); font-family: inherit; font-size: 0.85rem; border-radius: 4px;">
      </div>
    </div>

    <footer>
      <div class="block-title" id="block-title">‚Äî</div>
      <div class="footer-right">
        <div class="speed-control">
          <input type="range" id="speed-slider" min="1" max="20" value="20" step="1">
          <div class="slider-progress" id="slider-progress"></div>
          <div class="speed-label-wrapper">
            <span class="speed-label" id="speed-label">20s</span>
          </div>
        </div>
        <div class="timer-controls">
          <button id="shuffle-btn">‚§Æ</button>
          <button id="fullscreen-btn">‚õ∂</button>
        </div>
      </div>
    </footer>
  </div>

  <div class="nav-hint">‚Üê ‚Üí to navigate ¬∑ space to pause ¬∑ ctrl+v to drop are.na link</div>

  <script>
    let interval = 20000; // 20 seconds per slide (dynamic)

    let blocks = [];
    let currentIndex = 0;
    let isPlaying = true;
    let timer = null;
    let channelSlug = null;
    let progressTimer = null;
    let progressStart = 0;
    let labelFadeTimeout = null;
    let isShuffled = false;
    let originalBlocks = [];

    const stage = document.getElementById('stage');
    const counter = document.getElementById('counter');
    const blockTitle = document.getElementById('block-title');
    const playBtn = document.getElementById('play-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const channelInput = document.getElementById('channel-input');
    const channelName = document.getElementById('channel-name');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const shuffleBtn = document.getElementById('shuffle-btn');
    const speedSlider = document.getElementById('speed-slider');
    const speedLabel = document.getElementById('speed-label');
    const sliderProgress = document.getElementById('slider-progress');

    function extractChannelSlug(url) {
      // Extract slug from Are.na URL like https://www.are.na/username/channel-slug
      const match = url.match(/are\.na\/[^\/]+\/([^\/?\s]+)/);
      return match ? match[1] : null;
    }

    function showLoading() {
      stage.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <span style="font-size: 0.75rem; color: var(--dim);">Loading channel...</span>
        </div>
      `;
    }

    async function fetchChannel(slug) {
      channelSlug = slug;
      showLoading();
      try {
        // Fetch all pages of channel content
        let allContents = [];
        let page = 1;
        let totalPages = 1;
        let channelData = null;

        while (page <= totalPages) {
          const apiUrl = `https://api.are.na/v2/channels/${slug}?per=100&page=${page}`;
          const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(apiUrl)}`);
          if (!response.ok) throw new Error('Failed to fetch channel');
          const data = await response.json();

          if (page === 1) {
            channelData = data;
            totalPages = Math.ceil(data.length / 100);
          }

          allContents = allContents.concat(data.contents);
          page++;
        }

        blocks = allContents.filter(block =>
          block.class === 'Image' ||
          block.class === 'Text' ||
          block.class === 'Link' ||
          block.class === 'Media' ||
          block.class === 'Attachment'
        );

        if (blocks.length === 0) {
          throw new Error('No displayable content in channel');
        }

        // Update channel name in header
        channelName.innerHTML = `<a href="https://www.are.na/${channelData.user.slug}/${channelData.slug}" target="_blank" rel="noopener">${channelData.title}</a>`;

        renderSlides();
        showSlide(0);
        startAutoPlay();
      } catch (error) {
        stage.innerHTML = `
          <div class="error">
            <p>Could not load channel</p>
            <p style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.6;">${error.message}</p>
          </div>
        `;
      }
    }

    function renderSlides() {
      stage.innerHTML = '';
      
      blocks.forEach((block, index) => {
        const slide = document.createElement('div');
        slide.className = 'slide';
        slide.dataset.index = index;
        
        if (block.class === 'Image') {
          slide.innerHTML = `<img src="${block.image?.display?.url || block.image?.original?.url}" alt="${block.title || ''}" loading="lazy">`;
        } else if (block.class === 'Text') {
          slide.innerHTML = `<div class="slide-text">${block.content_html || block.content}</div>`;
        } else if (block.class === 'Link') {
          const imgUrl = block.image?.display?.url || block.image?.thumb?.url;
          slide.innerHTML = `
            <div class="slide-link">
              ${imgUrl ? `<img src="${imgUrl}" alt="">` : ''}
              ${block.title ? `<div class="link-title">${block.title}</div>` : ''}
              <a href="${block.source?.url}" target="_blank" rel="noopener">${block.source?.url}</a>
            </div>
          `;
        } else if (block.class === 'Media') {
          if (block.embed?.html) {
            slide.innerHTML = `<div class="slide-embed">${block.embed.html}</div>`;
          } else {
            const imgUrl = block.image?.display?.url;
            slide.innerHTML = imgUrl 
              ? `<img src="${imgUrl}" alt="${block.title || ''}">`
              : `<div class="slide-text">${block.title || 'Embedded media'}</div>`;
          }
        } else if (block.class === 'Attachment') {
          slide.innerHTML = `
            <div class="slide-attachment">
              <div class="file-icon">üìÑ</div>
              <a href="${block.attachment?.url}" target="_blank" rel="noopener">${block.title || 'Download attachment'}</a>
            </div>
          `;
        }
        
        stage.appendChild(slide);
      });
    }

    function fitTextToSlide(slideElement) {
      const textElement = slideElement.querySelector('.slide-text');
      if (!textElement) return;

      // Reset to default size first
      textElement.style.fontSize = '1.5rem';

      // Check if content overflows
      const slideHeight = slideElement.clientHeight;
      const textHeight = textElement.scrollHeight;

      if (textHeight > slideHeight) {
        // Binary search for optimal font size
        let minSize = 0.5;
        let maxSize = 1.5;
        let optimalSize = maxSize;

        while (maxSize - minSize > 0.05) {
          const midSize = (minSize + maxSize) / 2;
          textElement.style.fontSize = `${midSize}rem`;

          if (textElement.scrollHeight <= slideHeight) {
            optimalSize = midSize;
            minSize = midSize;
          } else {
            maxSize = midSize;
          }
        }

        textElement.style.fontSize = `${optimalSize}rem`;
      }
    }

    function showSlide(index) {
      if (blocks.length === 0) return;

      currentIndex = ((index % blocks.length) + blocks.length) % blocks.length;

      document.querySelectorAll('.slide').forEach((slide, i) => {
        slide.classList.toggle('active', i === currentIndex);
      });

      counter.textContent = `${currentIndex + 1}/${blocks.length}`;
      blockTitle.textContent = blocks[currentIndex].title || blocks[currentIndex].class || '‚Äî';

      // Fit text to slide after it becomes active
      const activeSlide = document.querySelector('.slide.active');
      if (activeSlide) {
        setTimeout(() => fitTextToSlide(activeSlide), 50);
      }

      resetProgress();
    }

    function resetProgress() {
      if (progressTimer) cancelAnimationFrame(progressTimer);
      progressStart = Date.now();

      if (isPlaying) {
        sliderProgress.classList.remove('paused');
        animateProgress();
      } else {
        sliderProgress.classList.add('paused');
      }
    }

    function animateProgress() {
      const elapsed = Date.now() - progressStart;
      const percent = Math.min((elapsed / interval) * 100, 100);

      // Calculate the maximum width based on current thumb position
      const padding = 6;
      const sliderWidth = speedSlider.offsetWidth;
      const usableWidth = sliderWidth - (2 * padding);

      // Get current slider value to determine thumb position
      const min = parseFloat(speedSlider.min);
      const max = parseFloat(speedSlider.max);
      const currentValue = parseFloat(speedSlider.value);
      const thumbPercent = ((currentValue - min) / (max - min));
      const maxProgressWidth = thumbPercent * usableWidth;

      // Progress fills up to the thumb position
      const progressWidth = (percent / 100) * maxProgressWidth;
      sliderProgress.style.width = `${progressWidth}px`;

      if (percent < 100 && isPlaying) {
        progressTimer = requestAnimationFrame(animateProgress);
      }
    }

    function startAutoPlay() {
      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        if (isPlaying) {
          showSlide(currentIndex + 1);
        }
      }, interval);
    }

    function togglePlay() {
      isPlaying = !isPlaying;
      playBtn.textContent = isPlaying ? 'Pause' : 'Play';
      playBtn.classList.toggle('active', !isPlaying);

      if (isPlaying) {
        // Resume from where we left off
        const currentWidth = parseFloat(sliderProgress.style.width) || 0;
        const padding = 6;
        const sliderWidth = speedSlider.offsetWidth;
        const usableWidth = sliderWidth - (2 * padding);
        const currentPercent = (currentWidth / usableWidth) * 100;
        progressStart = Date.now() - (currentPercent / 100 * interval);
        sliderProgress.classList.remove('paused');
        animateProgress();
      } else {
        sliderProgress.classList.add('paused');
        if (progressTimer) cancelAnimationFrame(progressTimer);
      }
    }

    function showLabel() {
      speedLabel.classList.add('visible');

      // Clear existing timeout
      if (labelFadeTimeout) {
        clearTimeout(labelFadeTimeout);
      }

      // Set new timeout to fade after 2 seconds
      labelFadeTimeout = setTimeout(() => {
        speedLabel.classList.remove('visible');
      }, 2000);
    }

    function updateSpeed(newSpeed) {
      interval = newSpeed * 1000; // Convert seconds to milliseconds
      speedLabel.textContent = `${newSpeed}`;

      // Show label when slider moves
      showLabel();

      // Restart the autoplay timer with new interval
      if (timer) {
        clearInterval(timer);
        startAutoPlay();
      }

      // Recalculate progress based on new interval
      if (isPlaying) {
        const currentWidth = parseFloat(sliderProgress.style.width) || 0;
        const padding = 6;
        const sliderWidth = speedSlider.offsetWidth;
        const usableWidth = sliderWidth - (2 * padding);
        const currentPercent = (currentWidth / usableWidth) * 100;
        progressStart = Date.now() - (currentPercent / 100 * interval);
      }
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        fullscreenBtn.textContent = '‚õ∂';
      } else {
        document.exitFullscreen();
        fullscreenBtn.textContent = '‚õ∂';
      }
    }

    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function toggleShuffle() {
      if (!isShuffled) {
        // Save original order and shuffle
        originalBlocks = [...blocks];
        blocks = shuffleArray(blocks);
        isShuffled = true;
        shuffleBtn.classList.add('active');
      } else {
        // Restore original order
        blocks = [...originalBlocks];
        isShuffled = false;
        shuffleBtn.classList.remove('active');
      }

      // Re-render slides and go to first slide
      renderSlides();
      showSlide(0);
      if (isPlaying) {
        startAutoPlay();
      }
    }

    // Event listeners
    playBtn.addEventListener('click', togglePlay);
    prevBtn.addEventListener('click', () => showSlide(currentIndex - 1));
    nextBtn.addEventListener('click', () => showSlide(currentIndex + 1));
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    shuffleBtn.addEventListener('click', toggleShuffle);

    speedSlider.addEventListener('input', (e) => {
      updateSpeed(parseFloat(e.target.value));
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') showSlide(currentIndex - 1);
      if (e.key === 'ArrowRight') showSlide(currentIndex + 1);
      if (e.key === ' ') {
        e.preventDefault();
        togglePlay();
      }
    });

    // Listen for paste events
    document.addEventListener('paste', (e) => {
      const text = e.clipboardData.getData('text/plain');
      const slug = extractChannelSlug(text);
      if (slug) {
        e.preventDefault();
        fetchChannel(slug);
      }
    });

    // Channel input handling
    channelInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const input = channelInput.value.trim();
        const slug = extractChannelSlug(input);
        if (slug) {
          fetchChannel(slug);
        } else {
          stage.innerHTML = `
            <div class="error">
              <p>Invalid Are.na URL</p>
              <p style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.6;">Expected format: https://www.are.na/username/channel-slug</p>
            </div>
          `;
        }
      }
    });

    // Drag and drop handling (global)
    document.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
    });

    document.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();

      const url = e.dataTransfer.getData('text/plain');
      const slug = extractChannelSlug(url);
      if (slug) {
        fetchChannel(slug);
      }
    });

    // Initialize label (without showing it)
    const initialValue = parseFloat(speedSlider.value);
    interval = initialValue * 1000;
    speedLabel.textContent = `${initialValue}`;
  </script>
</body>
</html>
